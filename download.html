<!DOCTYPE html>
<html lang="pl">
<head>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/components/icon.min.css" />
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pobierz DBM Mods</title>
  <style>
    body {
      min-height: 100vh;
      margin: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
      color: #e0d6ff;
      background: linear-gradient(120deg, #181028, #2d1846, #181028, #3a2060);
      background-size: 400% 400%;
      animation: gradientBG 12s ease-in-out infinite;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      box-sizing: border-box;
      width: 100vw;
      min-width: 0;
      overflow-x: hidden;
    }
    @keyframes gradientBG {
      0% {background-position: 0% 50%;}
      50% {background-position: 100% 50%;}
      100% {background-position: 0% 50%;}
    }
    h1 {
      font-size: 2rem;
      margin-bottom: 12px;
      letter-spacing: 1px;
      color: #c7a6ff;
      text-shadow: 0 2px 16px #000a;
      text-align: center;
      width: 100%;
    }
    .btns {
      display: flex;
      gap: 16px;
      margin-bottom: 18px;
      flex-wrap: wrap;
      justify-content: center;
      width: 100%;
    }
    .file-section {
      background: #23203a;
      border-radius: 12px;
      box-shadow: 0 2px 12px #0005;
      padding: 16px 10px 12px 10px;
      margin-bottom: 18px;
      min-width: 0;
      max-width: 98vw;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      box-sizing: border-box;
    }
    #main-content {
      display: flex;
      flex-direction: row;
      align-items: flex-start;
      justify-content: center;
      width: 100%;
      gap: 24px;
      max-width: 1200px;
      margin: 0 auto;
      box-sizing: border-box;
    }
    .main-col {
      flex: 1 1 0;
      min-width: 0;
      max-width: 420px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      box-sizing: border-box;
    }
    #directLinksPanel {
      flex: 0 0 340px;
      align-self: flex-start;
      margin: 0 18px;
      max-width: 340px;
      min-width: 220px;
      width: 100%;
    }
    @media (max-width: 900px) {
      #main-content { flex-direction: column; gap: 0; max-width: 98vw; }
      #directLinksPanel { max-width: 98vw; min-width: 0; margin: 0 0 12px 0; }
      .main-col { max-width: 98vw; min-width: 0; }
    }
    #fileLists {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 16px;
      min-width: 0;
      max-width: 98vw;
      width: 100%;
      box-sizing: border-box;
    }
    .file-section {
      background: #23203a;
      border-radius: 14px;
      box-shadow: 0 2px 12px #0005;
      padding: 24px 18px 18px 18px;
      margin-bottom: 0;
      min-width: 320px;
      max-width: 420px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }
    #directLinksPanel {
      background: #181028;
      border-radius: 12px;
      box-shadow: 0 2px 12px #0005;
      padding: 12px 10px 12px 10px;
      min-width: 0;
      max-width: 320px;
      width: 100%;
      margin-right: 0;
      margin-bottom: 18px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      height: fit-content;
      box-sizing: border-box;
    }
    #directLinksPanel h3 {
      color: #c7a6ff;
      font-size: 1.1rem;
      margin-top: 0;
      margin-bottom: 12px;
      text-align: left;
    }
    .direct-link-select {
      width: 100%;
      min-width: 180px;
      max-width: 320px;
      min-height: 40px;
      background: #2d1846;
      color: #e0d6ff;
      border-radius: 8px;
      border: 1px solid #3a2060;
      font-size: 1.05rem;
      margin-bottom: 12px;
      padding: 8px;
      scrollbar-width: thin;
      scrollbar-color: #a084ff #2d1846;
      outline: none;
    }
    .direct-link-select option {
      padding: 6px 8px;
      border-radius: 6px;
      margin-bottom: 2px;
      transition: background 0.15s, color 0.15s;
    }
    .direct-link-select:focus option:checked, .direct-link-select option:checked {
      background: #6c3fd1;
      color: #fff;
      font-weight: bold;
    }
    .direct-link-select::-webkit-scrollbar {
      width: 8px;
      background: #2d1846;
      border-radius: 8px;
    }
    .direct-link-select::-webkit-scrollbar-thumb {
      background: #a084ff;
      border-radius: 8px;
    }
    @media (max-width: 900px) {
      #main-content { flex-direction: column; gap: 0; max-width: 98vw; }
      #directLinksPanel { max-width: 98vw; min-width: 0; margin-bottom: 12px; }
      #fileLists { max-width: 98vw; min-width: 0; }
    }
    @media (max-width: 600px) {
      h1 { font-size: 1.1rem; }
      .btns { gap: 8px; margin-bottom: 8px; }
      #main-content { flex-direction: column; gap: 0; max-width: 100vw; }
      #directLinksPanel { display: none !important; }
      .file-section { padding: 8px 2vw; font-size: 0.95rem; }
      .file-select, .direct-link-select { font-size: 0.95rem; min-height: 60px; }
      #fileLists { gap: 8px; }
    }
    .file-section h2 {
      margin-top: 0;
      margin-bottom: 12px;
      color: #c7a6ff;
      font-size: 1.3rem;
      text-align: left;
    }
    .file-select {
      width: 100%;
      min-height: 120px;
      background: #2d1846;
      color: #e0d6ff;
      border-radius: 8px;
      border: 1px solid #3a2060;
      font-size: 1.08rem;
      margin-bottom: 14px;
      padding: 8px;
      scrollbar-width: thin;
      scrollbar-color: #a084ff #2d1846;
      outline: none;
    }
    .file-select option {
      padding: 6px 8px;
      border-radius: 6px;
      margin-bottom: 2px;
      transition: background 0.15s, color 0.15s;
    }
    .file-select:focus option:checked, .file-select option:checked {
      background: #6c3fd1;
      color: #fff;
      font-weight: bold;
    }
    .file-select::-webkit-scrollbar {
      width: 8px;
      background: #2d1846;
      border-radius: 8px;
    }
    .file-select::-webkit-scrollbar-thumb {
      background: #a084ff;
      border-radius: 8px;
    }
    .file-section button {
      margin-bottom: 0;
      margin-right: 12px;
      margin-top: 0;
      padding: 10px 22px;
      font-size: 1.08rem;
    }
    @media (max-width: 600px) {
      .file-section { min-width: 98vw; max-width: 98vw; padding: 12px 4vw; }
      .file-select { min-height: 80px; font-size: 0.98rem; }
    }
    button {
      background: linear-gradient(90deg, #6c3fd1 0%, #2d1846 100%);
      color: #fff;
      border: none;
      padding: 16px 36px;
      font-size: 1.2rem;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      box-shadow: 0 2px 12px #0005;
      transition: background 0.2s, color 0.2s, opacity 0.2s;
      outline: none;
    }
    button:disabled {
      background: #3a2c4d;
      color: #a89cc4;
      cursor: not-allowed;
      opacity: 0.7;
      box-shadow: none;
    }
    #status {
      margin-top: 18px;
      font-size: 1.1rem;
      min-height: 24px;
      color: #e0d6ff;
      text-shadow: 0 1px 8px #000a;
    }
    #progressBar {
      margin: 24px auto 0 auto;
      width: 80vw;
      max-width: 420px;
      height: 18px;
      background: #2d1846;
      border-radius: 9px;
      overflow: hidden;
      display: none;
      box-shadow: 0 2px 8px #0005;
    }
    #progressBarInner {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #a084ff 0%, #6c3fd1 100%);
      transition: width 0.2s;
    }
    @media (max-width: 600px) {
      h1 { font-size: 1.3rem; }
      button { font-size: 1rem; padding: 12px 18px; }
      #progressBar { width: 98vw; }
    }
  </style>
    <style>
      /* Discord widget fixed to the right */
      #discord-widget-container {
        position: fixed;
        top: 32px;
        right: 24px;
        z-index: 1000;
        width: 350px;
        height: 500px;
        box-shadow: 0 4px 24px #0007;
        border-radius: 16px;
        overflow: hidden;
        background: #23272a;
        border: 1px solid #181028;
        display: flex;
        flex-direction: column;
        align-items: stretch;
      }
      @media (max-width: 1100px) {
        #discord-widget-container { display: none; }
      }
    </style>
</head>
<body>
  <h1>⬇️ Pobierz DBM Mods</h1>
  <div class="btns">
    <button id="refreshList">Odśwież listę</button>
  </div>
  <div id="main-content">
    <div class="main-col" id="actionsCol"></div>
    <div id="directLinksPanel">
      <h3>Bezpośrednie pobieranie</h3>
      <label for="directLinksActionsSelect" style="color:#c7a6ff;font-weight:500;margin-bottom:4px;">Actions</label>
    <select id="directLinksActionsSelect" class="direct-link-select" size="6"></select>
      <label for="directLinksEventsSelect" style="color:#c7a6ff;font-weight:500;margin-bottom:4px;">Events</label>
    <select id="directLinksEventsSelect" class="direct-link-select" size="6"></select>
    </div>
    <div class="main-col" id="eventsCol"></div>
  </div>
  <div id="status"></div>
  <div id="progressBar"><div id="progressBarInner"></div></div>

  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script>
    
    let recentUpdatedFiles = [];
    async function getRecentUpdatedFiles() {
      try {
        const res = await fetch('https://raw.githubusercontent.com/vxe3D/dbm-mods/main/Versions/versions.json');
        const versions = await res.json();
        
        const filesWithUpdate = Object.entries(versions)
          .map(([name, v]) => ({
            name,
            date: (v.updateDate && v.updateDate !== 'undefined') ? v.updateDate : v.createdDate
          }));

        filesWithUpdate.sort((a, b) => {
          const parse = s => {
            if (!s || s === 'undefined') return 0;
            const [d, t] = s.split(' ');
            const [day, month, year] = d.split('.');
            const [hour, min] = t ? t.split(':') : [0,0];
            return new Date(`${year}-${month}-${day}T${hour}:${min}:00`).getTime();
          };
          return parse(b.date) - parse(a.date);
        });
        recentUpdatedFiles = filesWithUpdate.slice(0, 5).map(f => f.name);
      } catch (e) {
        recentUpdatedFiles = [];
      }
    }
    const status = document.getElementById("status");
    const progressBar = document.getElementById("progressBar");
    const progressBarInner = document.getElementById("progressBarInner");
    const fileLists = document.getElementById("fileLists");
    const refreshBtn = document.getElementById("refreshList");

    async function getFiles(dir) {
      const res = await fetch('https://raw.githubusercontent.com/vxe3D/dbm-mods/main/Versions/versions.json');
      if (!res.ok) return [];
      const versions = await res.json();
      let files = Object.entries(versions)
        .filter(([name, v]) => v.folder === dir)
        .map(([name, v]) => ({
          name,
          download_url: `https://raw.githubusercontent.com/vxe3D/dbm-mods/main/${v.folder}/${name}`,
          updateDate: v.updateDate,
          createdDate: v.createdDate
        }));
      files.sort((a, b) => {
        const parseDate = s => {
          if (!s || s === 'undefined') return 0;
          const [d, t] = s.split(' ');
          const [day, month, year] = d.split('.');
          const [hour, min] = t ? t.split(':') : [0,0];
          return new Date(`${year}-${month}-${day}T${hour}:${min}:00`).getTime();
        };
        const dateA = parseDate(a.updateDate) || parseDate(a.createdDate);
        const dateB = parseDate(b.updateDate) || parseDate(b.createdDate);
        return dateB - dateA;
      });
      return files;
    }

    function createFileListSection(dir, files) {
      const section = document.createElement("section");
      section.className = "file-section";
      const title = document.createElement("h2");
      title.textContent = dir.charAt(0).toUpperCase() + dir.slice(1);
      section.appendChild(title);

      if (!files || files.length === 0) {
        const info = document.createElement("div");
        info.textContent = "Brak plików.";
        section.appendChild(info);
        return section;
      }

    
      const select = document.createElement("select");
      select.className = "file-select";
      select.multiple = true;
      select.size = Math.min(files.length, 10);
      files.forEach(file => {
        const option = document.createElement("option");
        option.value = file.name;
        option.dataset.url = file.download_url;
        if (recentUpdatedFiles.includes(file.name)) {
          option.textContent = '⭐ ' + file.name;
        } else {
          option.textContent = file.name;
        }
        select.appendChild(option);
      });
      section.appendChild(select);

      
      const btnSelected = document.createElement("button");
      btnSelected.textContent = "Pobierz wybrane";
      btnSelected.onclick = () => downloadSelected(dir, select);
      section.appendChild(btnSelected);

      
      const btnAll = document.createElement("button");
      btnAll.textContent = "Pobierz wszystko";
      btnAll.onclick = () => downloadAll(dir);
      section.appendChild(btnAll);

      return section;
    }

    
    function renderDirectLinks(dir, files) {
      const select = document.getElementById(dir === "actions" ? "directLinksActionsSelect" : "directLinksEventsSelect");
      select.innerHTML = "";
      if (!files || files.length === 0) {
        const option = document.createElement("option");
        option.textContent = "Brak plików.";
        option.disabled = true;
        select.appendChild(option);
        return;
      }
      files.forEach(file => {
        const option = document.createElement("option");
        option.value = file.download_url;
        // Pokaz gwiazdkę w liście, ale zapisz czystą nazwę w data-filename
        if (recentUpdatedFiles.includes(file.name)) {
          option.textContent = '⭐ ' + file.name;
        } else {
          option.textContent = file.name;
        }
        option.dataset.filename = file.name;
        select.appendChild(option);
      });
      select.onchange = function() {
        const selected = select.options[select.selectedIndex];
        if (!selected || !selected.value) return;
        fetch(selected.value)
          .then(res => res.blob())
          .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const tempLink = document.createElement("a");
            tempLink.href = url;
            // Użyj czystej nazwy pliku bez gwiazdki
            tempLink.download = selected.dataset.filename || selected.textContent.replace(/^⭐\s*/, "");
            document.body.appendChild(tempLink);
            tempLink.click();
            setTimeout(() => {
              document.body.removeChild(tempLink);
              window.URL.revokeObjectURL(url);
            }, 100);
          });
        select.selectedIndex = -1;
      };
    }

    async function renderFileLists() {
  
  document.getElementById("actionsCol").innerHTML = "";
  document.getElementById("eventsCol").innerHTML = "";
  status.textContent = "Pobieranie listy plików...";
  let [actions, events] = await Promise.all([getFiles("actions"), getFiles("events")]);
  if (!Array.isArray(actions)) actions = [];
  if (!Array.isArray(events)) events = [];
  renderDirectLinks("actions", actions);
  renderDirectLinks("events", events);
  document.getElementById("actionsCol").appendChild(createFileListSection("actions", actions));
  document.getElementById("eventsCol").appendChild(createFileListSection("events", events));
  status.textContent = "Wybierz pliki do pobrania.";
    }

    async function downloadSelected(dir, select) {
      const selectedOptions = Array.from(select.selectedOptions);
      if (selectedOptions.length === 0) {
        status.textContent = "Nie wybrano żadnych plików.";
        return;
      }
      status.textContent = `Pobieranie wybranych plików z ${dir}...`;
      progressBar.style.display = "block";
      progressBarInner.style.width = "0%";
      try {
        let JSZipCtor = null;
        if (typeof window.JSZip === 'function') {
          JSZipCtor = window.JSZip;
        } else if (window.JSZip && typeof window.JSZip.default === 'function') {
          JSZipCtor = window.JSZip.default;
        } else if (window.JSZip && window.JSZip.default && typeof window.JSZip.default.default === 'function') {
          JSZipCtor = window.JSZip.default.default;
        }
        if (typeof JSZipCtor !== 'function') {
          status.textContent = "❌ Nie udało się załadować JSZip.";
          return;
        }
        const zip = new JSZipCtor();
        let i = 0;
        for (const opt of selectedOptions) {
          status.textContent = `Pobieranie ${opt.value} (${i+1}/${selectedOptions.length})...`;
          const res = await fetch(opt.dataset.url);
          const text = await res.text();
          zip.file(opt.value, text);
          progressBarInner.style.width = `${Math.round(((i+1)/selectedOptions.length)*100)}%`;
          i++;
        }
        status.textContent = "Tworzenie archiwum ZIP...";
        const blob = await zip.generateAsync({ type: "blob" });
        window.saveAs(blob, `${dir}_wybrane.zip`);
        status.textContent = "✅ Pobieranie zakończone!";
        progressBarInner.style.width = "100%";
      } catch (err) {
        console.error(err);
        status.textContent = "❌ Wystąpił błąd. Sprawdź konsolę.";
        progressBarInner.style.width = "0%";
      }
    }

    async function downloadAll(dir) {
      status.textContent = `Pobieranie wszystkich plików z ${dir}...`;
      progressBar.style.display = "block";
      progressBarInner.style.width = "0%";
      try {
        let JSZipCtor = null;
        if (typeof window.JSZip === 'function') {
          JSZipCtor = window.JSZip;
        } else if (window.JSZip && typeof window.JSZip.default === 'function') {
          JSZipCtor = window.JSZip.default;
        } else if (window.JSZip && window.JSZip.default && typeof window.JSZip.default.default === 'function') {
          JSZipCtor = window.JSZip.default.default;
        }
        if (typeof JSZipCtor !== 'function') {
          status.textContent = "❌ Nie udało się załadować JSZip.";
          return;
        }
        const files = await getFiles(dir);
        if (!files || files.length === 0) {
          status.textContent = "Brak plików do pobrania.";
          return;
        }
        const zip = new JSZipCtor();
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          status.textContent = `Pobieranie ${file.name} (${i+1}/${files.length})...`;
          const res = await fetch(file.download_url);
          const text = await res.text();
          zip.file(file.name, text);
          progressBarInner.style.width = `${Math.round(((i+1)/files.length)*100)}%`;
        }
        status.textContent = "Tworzenie archiwum ZIP...";
        const blob = await zip.generateAsync({ type: "blob" });
        window.saveAs(blob, `${dir}.zip`);
        status.textContent = "✅ Pobieranie zakończone!";
        progressBarInner.style.width = "100%";
      } catch (err) {
        console.error(err);
        status.textContent = "❌ Wystąpił błąd. Sprawdź konsolę.";
        progressBarInner.style.width = "0%";
      }
    }

    refreshBtn.addEventListener("click", async () => {
      await getRecentUpdatedFiles();
      renderFileLists();
    });
    window.addEventListener("DOMContentLoaded", async () => {
      await getRecentUpdatedFiles();
      renderFileLists();
    });
  </script>
</html>
